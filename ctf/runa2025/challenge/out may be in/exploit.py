#!/usr/bin/env python3
from pwn import *

context.log_level = 'info'

def parse_result(data):
    """Parse Strike, Ball, Out"""
    try:
        if b'Strike:' in data:
            parts = data.split(b'Strike:')[1].split(b'Ball:')
            strikes = int(parts[0].strip().split()[0])
            
            parts = data.split(b'Ball:')[1].split(b'Out:')
            balls = int(parts[0].strip().split()[0])
            
            outs = int(data.split(b'Out:')[1].strip().split()[0])
            
            return strikes, balls, outs
    except:
        pass
    return None, None, None

HOST = 'rev.runa2025.kr'
PORT = 5008

# Answer: 71395
answer = "71395"

log.info(f"Answer: {answer}")
log.info(f"Strategy: 4 correct guesses + 1 wrong guess")
log.info(f"Target: 24S 0B 1O = 237 points")

# Create a guess with 4S 1O
# Keep first 4 digits correct, change last one
wrong_guess = answer[:4] + '0'  # 71390 - change 5 to 0

log.info(f"Wrong guess: {wrong_guess} (should give 4S 0B 1O)")

p = remote(HOST, PORT)
p.recvuntil(b'Good luck!\n')
p.recvuntil(b'----------------------------\n')

guesses = [answer, answer, answer, answer, wrong_guess]
results = []

for try_num, guess in enumerate(guesses, 1):
    p.recvuntil(b'Enter 5-digit number> ')
    
    log.info(f"Try #{try_num}: {guess}")
    p.sendline(guess.encode())
    
    if try_num < 5:
        data = p.recvuntil(b'Try #', timeout=3)
        p.unrecv(b'Try #')
    else:
        data = p.recvall(timeout=3)
    
    strikes, balls, outs = parse_result(data)
    results.append((strikes, balls, outs))
    
    log.info(f"  â†’ {strikes}S {balls}B {outs}O")

# Calculate score
total_s = sum(r[0] for r in results)
total_b = sum(r[1] for r in results)
total_o = sum(r[2] for r in results)
score = 10 * total_s + 5 * total_b - 3 * total_o

log.info(f"\n=== Final Result ===")
log.info(f"Total: {total_s}S {total_b}B {total_o}O")
log.info(f"Score: {score}")

if score == 237:
    log.success("TARGET SCORE ACHIEVED! 237 points!")
else:
    log.warning(f"Score mismatch! Got {score}, expected 237")

log.info(f"\nFull output:\n{data.decode()}")

p.close()
